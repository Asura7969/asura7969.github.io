<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Flink Sql 侧流输出(一) | Asura7969 Blog</title><meta name="keywords" content="flink"><meta name="author" content="Asura7969"><meta name="copyright" content="Asura7969"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Flink Sql 侧流输出(一) 本章并没有实现完成, 到最后发现 sink 端不好搞，不感兴趣的可以直接看第二篇内容（本章内容中涉及到的代码与第二章大部分一样，只是处理的环节不同）  实现原理 预想的使用示例如下: 1、定义处理逻辑 12345678910public class MyProcessFunction extends ScalarFunction &amp;#123;    public">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink Sql 侧流输出(一)">
<meta property="og:url" content="https://asura7969.github.io/2021/06/05/Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%B8%80/index.html">
<meta property="og:site_name" content="Asura7969 Blog">
<meta property="og:description" content="Flink Sql 侧流输出(一) 本章并没有实现完成, 到最后发现 sink 端不好搞，不感兴趣的可以直接看第二篇内容（本章内容中涉及到的代码与第二章大部分一样，只是处理的环节不同）  实现原理 预想的使用示例如下: 1、定义处理逻辑 12345678910public class MyProcessFunction extends ScalarFunction &amp;#123;    public">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://asura7969.github.io/img/topimg/202106050955.png">
<meta property="article:published_time" content="2021-06-05T01:44:28.000Z">
<meta property="article:modified_time" content="2022-02-17T13:22:10.604Z">
<meta property="article:author" content="Asura7969">
<meta property="article:tag" content="flink">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asura7969.github.io/img/topimg/202106050955.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://asura7969.github.io/2021/06/05/Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%B8%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Flink Sql 侧流输出(一)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-17 21:22:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/shanyi.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">37</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/topimg/202106050955.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Asura7969 Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Flink Sql 侧流输出(一)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-05T01:44:28.000Z" title="发表于 2021-06-05 09:44:28">2021-06-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-17T13:22:10.604Z" title="更新于 2022-02-17 21:22:10">2022-02-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/sql/">sql</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Flink Sql 侧流输出(一)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Flink-Sql-侧流输出-一"><a href="#Flink-Sql-侧流输出-一" class="headerlink" title="Flink Sql 侧流输出(一)"></a>Flink Sql 侧流输出(一)</h1><blockquote>
<p>本章并没有实现完成, 到最后发现 sink 端不好搞，不感兴趣的可以直接看第二篇内容（本章内容中涉及到的代码与第二章大部分一样，只是处理的环节不同）</p>
</blockquote>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p><img src="/img/blog/sideOutput(%E4%B8%80).png" alt="sideOutput(一).png"></p>
<p>预想的使用示例如下:</p>
<p>1、定义处理逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessFunction</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Atest <span class="title">eval</span><span class="params">(Integer id1, String id2)</span> </span>&#123;</span><br><span class="line">        Atest a = <span class="keyword">new</span> Atest();</span><br><span class="line">        a.setId1(id1);</span><br><span class="line">        a.setId2(id2);</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2、注册UDF函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tEnv.createTemporarySystemFunction(<span class="string">&quot;SumFunction&quot;</span>, SumFunction.class);</span><br></pre></td></tr></table></figure>
<p>3、创建sink表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## sideOutput 输出端</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sideOutput_table(</span><br><span class="line">    id1 <span class="type">INT</span>,</span><br><span class="line">    id2 <span class="type">VARCHAR</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">&#x27;connector&#x27;</span><span class="operator">=</span><span class="string">&#x27;print&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;functionName&#x27;</span><span class="operator">=</span><span class="string">&#x27;MyProcessFunction&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tagName&#x27;</span><span class="operator">=</span><span class="string">&#x27;tag1&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>4、查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## sideOutput_table 为表名</span><br><span class="line">## SIDE_OUT_PUT 为关键字</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ SIDE_OUT_PUT(&#x27;sideOutput_table&#x27;) */</span> source.id2 <span class="keyword">FROM</span> source</span><br></pre></td></tr></table></figure>

<h2 id="一、添加提示信息"><a href="#一、添加提示信息" class="headerlink" title="一、添加提示信息"></a>一、添加提示信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkHints</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HINT_SIDE_OUT_PUT = <span class="string">&quot;SIDE_OUT_PUT&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getHintedSideOutput</span><span class="params">(List&lt;RelHint&gt; tableHints)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tableHints.stream()</span><br><span class="line">                .filter(hint -&gt; hint.hintName.equalsIgnoreCase(HINT_SIDE_OUT_PUT))</span><br><span class="line">                .flatMap(hint -&gt; hint.listOptions.stream())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkHintStrategies</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HintStrategyTable <span class="title">createHintStrategyTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HintStrategyTable.builder()</span><br><span class="line">                <span class="comment">// Configure to always throw when we encounter any hint errors</span></span><br><span class="line">                <span class="comment">// (either the non-registered hint or the hint format).</span></span><br><span class="line">                .errorHandler(Litmus.THROW)</span><br><span class="line">                .hintStrategy(</span><br><span class="line">                        FlinkHints.HINT_NAME_OPTIONS,</span><br><span class="line">                        HintStrategy.builder(HintPredicates.TABLE_SCAN)</span><br><span class="line">                                .optionChecker(</span><br><span class="line">                                        (hint, errorHandler) -&gt;</span><br><span class="line">                                                errorHandler.check(</span><br><span class="line">                                                        hint.kvOptions.size() &gt; <span class="number">0</span>,</span><br><span class="line">                                                        <span class="string">&quot;Hint [&#123;&#125;] only support non empty key value options&quot;</span>,</span><br><span class="line">                                                        hint.hintName))</span><br><span class="line">                                .build())</span><br><span class="line">                <span class="comment">// 添加测流校验</span></span><br><span class="line">                .hintStrategy(</span><br><span class="line">                        FlinkHints.HINT_SIDE_OUT_PUT,</span><br><span class="line">                        HintStrategy.builder(HintPredicates.PROJECT)</span><br><span class="line">                                .optionChecker(</span><br><span class="line">                                        (hint, errorHandler) -&gt;</span><br><span class="line">                                                errorHandler.check(</span><br><span class="line">                                                        hint.listOptions.size() &gt; <span class="number">0</span>,</span><br><span class="line">                                                        <span class="string">&quot;Hint [&#123;&#125;] only support non empty list&quot;</span>,</span><br><span class="line">                                                        hint.hintName))</span><br><span class="line">                                .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二、SqlToOperationConverter-添加校验"><a href="#二、SqlToOperationConverter-添加校验" class="headerlink" title="二、SqlToOperationConverter 添加校验"></a>二、SqlToOperationConverter 添加校验</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PlannerQueryOperation <span class="title">toQueryOperation</span><span class="params">(FlinkPlannerImpl planner, SqlNode validated)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// transform to a relational tree</span></span><br><span class="line">    RelRoot relational = planner.rel(validated);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!relational.hints.isEmpty()) &#123;</span><br><span class="line">        PlannerQueryOperation queryOperation = <span class="keyword">new</span> PlannerQueryOperation(</span><br><span class="line">                relational.project(),</span><br><span class="line">                relational.hints);</span><br><span class="line">        Catalog catalog = catalogManager.getCatalog(catalogManager.getCurrentCatalog()).get();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; allTables = catalog.listTables(catalogManager.getCurrentDatabase());</span><br><span class="line">            <span class="keyword">if</span> (!allTables.containsAll(queryOperation.getSideOutputHints())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;must register sideOutput table:&quot;</span></span><br><span class="line">                        + queryOperation.getSideOutputHints());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> queryOperation;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DatabaseNotExistException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PlannerQueryOperation(relational.project(), relational.hints);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、修改-PROJECT-TO-CALC"><a href="#三、修改-PROJECT-TO-CALC" class="headerlink" title="三、修改 PROJECT_TO_CALC"></a>三、修改 PROJECT_TO_CALC</h2><p>原始实现会忽略 project 中 hint 的提示信息</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.flink.table.planner.plan.rules.logical</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.plan.&#123;<span class="type">RelOptRule</span>, <span class="type">RelOptRuleCall</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.plan.<span class="type">RelOptRule</span>.&#123;any, operand&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.logical.&#123;<span class="type">LogicalCalc</span>, <span class="type">LogicalProject</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rex.<span class="type">RexProgram</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlinkProjectToCalcRule</span> <span class="keyword">extends</span> <span class="title">RelOptRule</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">  operand(classOf[<span class="type">LogicalProject</span>], any(</span>)),</span></span><br><span class="line">  <span class="string">&quot;FlinkProjectToCalcRule&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onMatch</span></span>(call: <span class="type">RelOptRuleCall</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> project: <span class="type">LogicalProject</span> = call.rel(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> input = project.getInput</span><br><span class="line">    <span class="keyword">val</span> program = <span class="type">RexProgram</span>.create(</span><br><span class="line">      input.getRowType,</span><br><span class="line">      project.getProjects,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      project.getRowType,</span><br><span class="line">      project.getCluster.getRexBuilder)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> calc = <span class="keyword">if</span> (!project.getHints.isEmpty) &#123;</span><br><span class="line">      <span class="type">LogicalCalc</span>.create(input, program).withHints(project.getHints)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">LogicalCalc</span>.create(input, program)</span><br><span class="line">    &#125;</span><br><span class="line">    call.builder()</span><br><span class="line">    call.transformTo(calc)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FlinkProjectToCalcRule</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> <span class="type">INSTANCE</span> = <span class="keyword">new</span> <span class="type">FlinkProjectToCalcRule</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LOGICAL_RULES</code>中添加规则</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    CoreRules.PROJECT_TO_CALC,</span></span><br><span class="line">    <span class="type">FlinkProjectToCalcRule</span>.<span class="type">INSTANCE</span>,</span><br></pre></td></tr></table></figure>


<h2 id="四、重写-FlinkLogicalCalc-节点"><a href="#四、重写-FlinkLogicalCalc-节点" class="headerlink" title="四、重写 FlinkLogicalCalc 节点"></a>四、重写 FlinkLogicalCalc 节点</h2><p><code>FlinkLogicalCalc</code> 实现中并未涉及到 hint信息,故需要修改,<br>因为涉及到<code>CommonCalc</code>的修改, 故同属子类也需要添加 <strong>hint</strong> 信息</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.flink.table.planner.plan.nodes.logical</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.plan.nodes.<span class="type">FlinkConventions</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.plan.nodes.common.<span class="type">CommonCalc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.plan._</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.convert.<span class="type">ConverterRule</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.core.<span class="type">Calc</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.logical.<span class="type">LogicalCalc</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.metadata.<span class="type">RelMdCollation</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.&#123;<span class="type">RelCollation</span>, <span class="type">RelCollationTraitDef</span>, <span class="type">RelNode</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rex.<span class="type">RexProgram</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Collections</span></span><br><span class="line"><span class="keyword">import</span> java.util.function.<span class="type">Supplier</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.hint.<span class="type">RelHint</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.<span class="type">JList</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Sub-class of [[Calc]] that is a relational expression which computes project expressions</span></span><br><span class="line"><span class="comment">  * and also filters in Flink.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlinkLogicalCalc</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">    cluster: <span class="type">RelOptCluster</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    traitSet: <span class="type">RelTraitSet</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    input: <span class="type">RelNode</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    calcProgram: <span class="type">RexProgram</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    hints: <span class="type">JList</span>[<span class="type">RelHint</span>]</span>)</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">CommonCalc</span>(cluster, traitSet, input, calcProgram, hints)</span><br><span class="line">  <span class="keyword">with</span> <span class="type">FlinkLogicalRel</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>(cluster: <span class="type">RelOptCluster</span>,</span><br><span class="line">           traitSet: <span class="type">RelTraitSet</span>,</span><br><span class="line">           input: <span class="type">RelNode</span>,</span><br><span class="line">           calcProgram: <span class="type">RexProgram</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>(cluster, traitSet, input, calcProgram, <span class="type">Collections</span>.emptyList[<span class="type">RelHint</span>]())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">copy</span></span>(traitSet: <span class="type">RelTraitSet</span>, child: <span class="type">RelNode</span>, program: <span class="type">RexProgram</span>): <span class="type">Calc</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">FlinkLogicalCalc</span>(cluster, traitSet, child, program, <span class="keyword">this</span>.getHints)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkLogicalCalcConverter</span></span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">ConverterRule</span>(</span><br><span class="line">    classOf[<span class="type">LogicalCalc</span>],</span><br><span class="line">    <span class="type">Convention</span>.<span class="type">NONE</span>,</span><br><span class="line">    <span class="type">FlinkConventions</span>.<span class="type">LOGICAL</span>,</span><br><span class="line">    <span class="string">&quot;FlinkLogicalCalcConverter&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">convert</span></span>(rel: <span class="type">RelNode</span>): <span class="type">RelNode</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> calc = rel.asInstanceOf[<span class="type">LogicalCalc</span>]</span><br><span class="line">    <span class="keyword">val</span> newInput = <span class="type">RelOptRule</span>.convert(calc.getInput, <span class="type">FlinkConventions</span>.<span class="type">LOGICAL</span>)</span><br><span class="line">    <span class="type">FlinkLogicalCalc</span>.create(newInput, calc.getProgram, calc.getHints)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FlinkLogicalCalc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> <span class="type">CONVERTER</span>: <span class="type">ConverterRule</span> = <span class="keyword">new</span> <span class="type">FlinkLogicalCalcConverter</span>()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span>(input: <span class="type">RelNode</span>, calcProgram: <span class="type">RexProgram</span>): <span class="type">FlinkLogicalCalc</span> = &#123;</span><br><span class="line">    create(input, calcProgram, <span class="type">Collections</span>.emptyList[<span class="type">RelHint</span>]())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span>(input: <span class="type">RelNode</span>, calcProgram: <span class="type">RexProgram</span>, hints: <span class="type">JList</span>[<span class="type">RelHint</span>]): <span class="type">FlinkLogicalCalc</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> cluster = input.getCluster</span><br><span class="line">    <span class="keyword">val</span> mq = cluster.getMetadataQuery</span><br><span class="line">    <span class="keyword">val</span> traitSet = cluster.traitSetOf(<span class="type">FlinkConventions</span>.<span class="type">LOGICAL</span>).replaceIfs(</span><br><span class="line">      <span class="type">RelCollationTraitDef</span>.<span class="type">INSTANCE</span>, <span class="keyword">new</span> <span class="type">Supplier</span>[util.<span class="type">List</span>[<span class="type">RelCollation</span>]]() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>: util.<span class="type">List</span>[<span class="type">RelCollation</span>] = <span class="type">RelMdCollation</span>.calc(mq, input, calcProgram)</span><br><span class="line">      &#125;).simplify()</span><br><span class="line">    <span class="keyword">new</span> <span class="type">FlinkLogicalCalc</span>(cluster, traitSet, input, calcProgram, hints)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改父类<code>CommonCalc</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.<span class="type">JList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCalc</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">    cluster: <span class="type">RelOptCluster</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    traitSet: <span class="type">RelTraitSet</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    input: <span class="type">RelNode</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    calcProgram: <span class="type">RexProgram</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    hints: <span class="type">JList</span>[<span class="type">RelHint</span>]</span>)</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">Calc</span>(cluster, traitSet, hints, input, calcProgram)</span><br><span class="line">  <span class="keyword">with</span> <span class="type">FlinkRelNode</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>(cluster: <span class="type">RelOptCluster</span>,</span><br><span class="line">           traitSet: <span class="type">RelTraitSet</span>,</span><br><span class="line">           input: <span class="type">RelNode</span>,</span><br><span class="line">           calcProgram: <span class="type">RexProgram</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>(cluster, traitSet, input, calcProgram, <span class="type">Collections</span>.emptyList[<span class="type">RelHint</span>]())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>


<h2 id="五、添加-StreamExecSideOutputCalc"><a href="#五、添加-StreamExecSideOutputCalc" class="headerlink" title="五、添加 StreamExecSideOutputCalc"></a>五、添加 StreamExecSideOutputCalc</h2><p>参考<code>StreamExecCalc</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.flink.table.planner.plan.nodes.physical.stream</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Objects</span>, <span class="type">Optional</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.plan.&#123;<span class="type">RelOptCluster</span>, <span class="type">RelTraitSet</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.<span class="type">RelNode</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.`<span class="class"><span class="keyword">type</span>`.<span class="title">RelDataType</span></span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.core.<span class="type">Calc</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rel.hint.<span class="type">RelHint</span></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rex.&#123;<span class="type">RexCall</span>, <span class="type">RexNode</span>, <span class="type">RexProgram</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.dag.<span class="type">Transformation</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.transformations.<span class="type">OneInputTransformation</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">ValidationException</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.catalog.&#123;<span class="type">Catalog</span>, <span class="type">CatalogBaseTable</span>, <span class="type">FunctionLookup</span>, <span class="type">ObjectPath</span>, <span class="type">UnresolvedIdentifier</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.catalog.exceptions.<span class="type">CatalogException</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.data.<span class="type">RowData</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.&#123;<span class="type">JList</span>, <span class="type">JMap</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.calcite.&#123;<span class="type">FlinkContext</span>, <span class="type">FlinkTypeFactory</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.codegen.&#123;<span class="type">CalcCodeGenerator</span>, <span class="type">CodeGeneratorContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.delegation.<span class="type">StreamPlanner</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.functions.bridging.<span class="type">BridgingSqlFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.hint.<span class="type">FlinkHints</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.utils.<span class="type">ShortcutUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.runtime.operators.<span class="type">AbstractProcessStreamOperator</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.runtime.typeutils.<span class="type">InternalTypeInfo</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.logical.<span class="type">LogicalType</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConverters</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamExecSideOutputCalc</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="class">    cluster: <span class="type">RelOptCluster</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    traitSet: <span class="type">RelTraitSet</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    inputRel: <span class="type">RelNode</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    calcProgram: <span class="type">RexProgram</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    outputRowType: <span class="type">RelDataType</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">    hints: <span class="type">JList</span>[<span class="type">RelHint</span>]</span>)</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">StreamExecCalcBase</span>(cluster, traitSet, inputRel, calcProgram, outputRowType, hints) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">type</span> <span class="title">ColumnInfo</span> </span>= <span class="type">JList</span>[(<span class="type">Int</span>, <span class="type">String</span>, <span class="type">LogicalType</span>)]</span><br><span class="line">  <span class="class"><span class="keyword">type</span> <span class="title">TableInfo</span> </span>= <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">ColumnInfo</span>]</span><br><span class="line">  <span class="class"><span class="keyword">type</span> <span class="title">BSF</span> </span>= <span class="type">BridgingSqlFunction</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> sideOutputTableInfo: <span class="type">TableInfo</span> = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">ColumnInfo</span>]()</span><br><span class="line">  <span class="keyword">val</span> tableAndFunction: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">BSF</span>] = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">BSF</span>]()</span><br><span class="line">  <span class="keyword">val</span> tableAndRexCall: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">RexCall</span>] = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">RexCall</span>]()</span><br><span class="line">  <span class="keyword">val</span> tableAndTagName: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">String</span>] = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">toScalaOption</span></span>[<span class="type">T</span>](op: <span class="type">Optional</span>[<span class="type">T</span>]): <span class="type">Option</span>[<span class="type">T</span>] = &#123;</span><br><span class="line">    <span class="keyword">if</span> (op.isPresent) &#123;</span><br><span class="line">      <span class="type">Some</span>(op.get())</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="type">None</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取一些 side_output table的信息, codegen 时候会用到</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generatorTableToFieldInfo</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> context = <span class="keyword">this</span>.cluster.getPlanner.getContext.unwrap(classOf[<span class="type">FlinkContext</span>])</span><br><span class="line">    <span class="keyword">val</span> hintsOp = <span class="type">Option</span>(getHints.asScala</span><br><span class="line">      .filter(_.hintName.equals(<span class="type">FlinkHints</span>.<span class="type">HINT_SIDE_OUT_PUT</span>))</span><br><span class="line">      .flatMap(_.listOptions.asScala))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> flinkTypeFactory = <span class="type">ShortcutUtils</span>.unwrapTypeFactory(cluster)</span><br><span class="line">    <span class="keyword">val</span> manager = context.getCatalogManager</span><br><span class="line">    <span class="keyword">val</span> functionCatalog = context.getFunctionCatalog</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rexBuilder = input.getCluster.getRexBuilder</span><br><span class="line">    <span class="keyword">val</span> inputRowType = input.getRowType</span><br><span class="line"></span><br><span class="line">    toScalaOption[<span class="type">Catalog</span>](manager.getCatalog(manager.getCurrentCatalog)).foreach &#123;</span><br><span class="line">      <span class="keyword">case</span> catalog: <span class="type">Catalog</span> =&gt;</span><br><span class="line">        hintsOp <span class="keyword">match</span> &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="type">Some</span>(sideOutputTables) =&gt;</span><br><span class="line">            sideOutputTables.foreach(tableName =&gt; &#123;</span><br><span class="line">              <span class="keyword">val</span> tableFullName = <span class="string">s&quot;<span class="subst">$&#123;manager.getCurrentDatabase&#125;</span>.<span class="subst">$tableName</span>&quot;</span></span><br><span class="line">              <span class="keyword">val</span> table: <span class="type">CatalogBaseTable</span> = catalog.getTable(<span class="type">ObjectPath</span>.fromString(tableFullName))</span><br><span class="line">              <span class="keyword">val</span> types: <span class="type">ColumnInfo</span> = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[(<span class="type">Int</span>, <span class="type">String</span>, <span class="type">LogicalType</span>)]()</span><br><span class="line">              <span class="keyword">val</span> functionName = validateExits(table.getOptions.get(<span class="string">&quot;functionName&quot;</span>))</span><br><span class="line">              <span class="keyword">val</span> tagName = validateExits(table.getOptions.get(<span class="string">&quot;tagName&quot;</span>))</span><br><span class="line"></span><br><span class="line">              tableAndTagName.put(tableName, tagName);</span><br><span class="line">              <span class="keyword">val</span> schema = table.getSchema</span><br><span class="line"></span><br><span class="line">              schema.getTableColumns.asScala.zipWithIndex.foreach(t =&gt; &#123;</span><br><span class="line">                types.add((t._2, t._1.getName, t._1.getType.getLogicalType))</span><br><span class="line">              &#125;)</span><br><span class="line"></span><br><span class="line">              sideOutputTableInfo.put(tableName, types)</span><br><span class="line"></span><br><span class="line">              <span class="keyword">val</span> result = functionCatalog.lookupFunction(<span class="type">UnresolvedIdentifier</span>.of(functionName))</span><br><span class="line">              toScalaOption[<span class="type">FunctionLookup</span>.<span class="type">Result</span>](result) <span class="keyword">match</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">Some</span>(functionLookup) =&gt;</span><br><span class="line">                  <span class="keyword">val</span> definition = functionLookup.getFunctionDefinition</span><br><span class="line">                  <span class="keyword">val</span> function = <span class="type">BridgingSqlFunction</span>.of(</span><br><span class="line">                    context,</span><br><span class="line">                    flinkTypeFactory,</span><br><span class="line">                    functionLookup.getFunctionIdentifier,</span><br><span class="line">                    definition)</span><br><span class="line"></span><br><span class="line">                  tableAndFunction.put(tableName, function)</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">val</span> dataType = flinkTypeFactory.buildRelNodeRowType(schema)</span><br><span class="line">                  <span class="keyword">val</span> operands = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">RexNode</span>](rexBuilder.identityProjects(dataType))</span><br><span class="line">                  <span class="keyword">val</span> rexCall = rexBuilder.makeCall(dataType, function, operands)</span><br><span class="line">                  tableAndRexCall.put(tableName, rexCall.asInstanceOf[<span class="type">RexCall</span>])</span><br><span class="line">                <span class="keyword">case</span> _ =&gt;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          <span class="keyword">case</span> _ =&gt;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">&quot;Only support sideOutput hints ...&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">CatalogException</span>(<span class="string">s&quot;<span class="subst">$&#123;manager.getCurrentCatalog&#125;</span> is null!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">copy</span></span>(traitSet: <span class="type">RelTraitSet</span>, child: <span class="type">RelNode</span>, program: <span class="type">RexProgram</span>): <span class="type">Calc</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">StreamExecSideOutputCalc</span>(cluster, traitSet, child, program, outputRowType, getHints)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">validateExits</span></span>[<span class="type">T</span>](v: <span class="type">T</span>): <span class="type">T</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">Objects</span>.isNull(v)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">s&quot;value is null: <span class="subst">$v</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span> v</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">validatePrepareInfo</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (sideOutputTableInfo.isEmpty || tableAndFunction.isEmpty || tableAndRexCall.isEmpty) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">s&quot;Must call generatorTableToFieldInfo method!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">translateToPlanInternal</span></span>(</span><br><span class="line">      planner: <span class="type">StreamPlanner</span>): <span class="type">Transformation</span>[<span class="type">RowData</span>] = &#123;</span><br><span class="line">    <span class="keyword">val</span> config = planner.getTableConfig</span><br><span class="line">    <span class="keyword">val</span> inputTransform = getInputNodes.get(<span class="number">0</span>).translateToPlan(planner)</span><br><span class="line">      .asInstanceOf[<span class="type">Transformation</span>[<span class="type">RowData</span>]]</span><br><span class="line">    <span class="comment">// materialize time attributes in condition</span></span><br><span class="line">    <span class="keyword">val</span> condition = <span class="keyword">if</span> (calcProgram.getCondition != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">Some</span>(calcProgram.expandLocalRef(calcProgram.getCondition))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ctx = <span class="type">CodeGeneratorContext</span>(config).setOperatorBaseClass(</span><br><span class="line">      classOf[<span class="type">AbstractProcessStreamOperator</span>[<span class="type">RowData</span>]])</span><br><span class="line">    <span class="keyword">val</span> outputType = <span class="type">FlinkTypeFactory</span>.toLogicalRowType(getRowType)</span><br><span class="line">    <span class="keyword">val</span> sideOutputCode = <span class="keyword">if</span> (!getHints.isEmpty) &#123;</span><br><span class="line">      generatorTableToFieldInfo()</span><br><span class="line">      validatePrepareInfo()</span><br><span class="line">      <span class="type">CalcCodeGenerator</span>.generateSideOutputCode(</span><br><span class="line">        ctx,</span><br><span class="line">        inputTransform,</span><br><span class="line">        outputType,</span><br><span class="line">        calcProgram,</span><br><span class="line">        condition,</span><br><span class="line">        retainHeader = <span class="literal">true</span>,</span><br><span class="line">        sideOutputTableInfo,</span><br><span class="line">        tableAndFunction,</span><br><span class="line">        tableAndRexCall,</span><br><span class="line">        tableAndTagName</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> substituteStreamOperator = <span class="type">CalcCodeGenerator</span>.generateCalcOperator(</span><br><span class="line">      ctx,</span><br><span class="line">      inputTransform,</span><br><span class="line">      outputType,</span><br><span class="line">      calcProgram,</span><br><span class="line">      condition,</span><br><span class="line">      retainHeader = <span class="literal">true</span>,</span><br><span class="line">      sideOutputCode,</span><br><span class="line">      <span class="string">&quot;StreamExecCalc&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> ret = <span class="keyword">new</span> <span class="type">OneInputTransformation</span>(</span><br><span class="line">      inputTransform,</span><br><span class="line">      getRelDetailedDescription,</span><br><span class="line">      substituteStreamOperator,</span><br><span class="line">      <span class="type">InternalTypeInfo</span>.of(outputType),</span><br><span class="line">      inputTransform.getParallelism)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inputsContainSingleton()) &#123;</span><br><span class="line">      ret.setParallelism(<span class="number">1</span>)</span><br><span class="line">      ret.setMaxParallelism(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    ret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FlinkChangelogModeInferenceProgram</code> 添加 <code>StreamExecSideOutputCalc</code>节点的匹配(274行)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> _: <span class="type">StreamExecCalc</span> | _: <span class="type">StreamExecSideOutputCalc</span> | _: <span class="type">StreamExecPythonCalc</span> | _: <span class="type">StreamExecCorrelate</span> |</span><br><span class="line">     _: <span class="type">StreamExecPythonCorrelate</span> | _: <span class="type">StreamExecLookupJoin</span> | _: <span class="type">StreamExecExchange</span> |</span><br><span class="line">     _: <span class="type">StreamExecExpand</span> | _: <span class="type">StreamExecMiniBatchAssigner</span> |</span><br><span class="line">     _: <span class="type">StreamExecWatermarkAssigner</span> =&gt;</span><br></pre></td></tr></table></figure>


<p><code>CalcCodeGenerator</code> 添加方法 <code>generateSideOutputCode</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.logical.&#123;<span class="type">LogicalType</span>, <span class="type">RowType</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.codegen.<span class="type">SideOutputCodeUtils</span>._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.&#123;<span class="type">JList</span>, <span class="type">JMap</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConverters</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CalcCodeGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 生成 SideOutput 的代码</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span>[flink] <span class="function"><span class="keyword">def</span> <span class="title">generateSideOutputCode</span></span>(</span><br><span class="line">      ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">      inputTransform: <span class="type">Transformation</span>[<span class="type">RowData</span>],</span><br><span class="line">      outputType: <span class="type">RowType</span>,</span><br><span class="line">      calcProgram: <span class="type">RexProgram</span>,</span><br><span class="line">      condition: <span class="type">Option</span>[<span class="type">RexNode</span>],</span><br><span class="line">      retainHeader: <span class="type">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line">      sideOutputTableInfo: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">JList</span>[(<span class="type">Int</span>, <span class="type">String</span>, <span class="type">LogicalType</span>)]],</span><br><span class="line">      tableAndFunction: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">BridgingSqlFunction</span>],</span><br><span class="line">      tableAndRexCall: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">RexCall</span>],</span><br><span class="line">      tableAndTagName: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">String</span>],</span><br><span class="line">      inputTerm: <span class="type">String</span> = <span class="type">CodeGenUtils</span>.<span class="type">DEFAULT_INPUT1_TERM</span>,</span><br><span class="line">      collectorTerm: <span class="type">String</span> = <span class="type">CodeGenUtils</span>.<span class="type">DEFAULT_OPERATOR_COLLECTOR_TERM</span>): <span class="type">String</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputType = inputTransform.getOutputType</span><br><span class="line">      .asInstanceOf[<span class="type">InternalTypeInfo</span>[<span class="type">RowData</span>]]</span><br><span class="line">      .toRowType</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableAndRexCal = tableAndRexCall.asScala.map(t =&gt; (t._1, t._2)).toList.zipWithIndex</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableMap = addReusable(ctx, tableAndRexCal, tableAndTagName)</span><br><span class="line">    produceProcessCode(ctx, inputType, collectorTerm, inputTerm, tableMap, tableAndRexCal)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span>[flink] <span class="function"><span class="keyword">def</span> <span class="title">generateCalcOperator</span></span>(</span><br><span class="line">      ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">      inputTransform: <span class="type">Transformation</span>[<span class="type">RowData</span>],</span><br><span class="line">      outputType: <span class="type">RowType</span>,</span><br><span class="line">      calcProgram: <span class="type">RexProgram</span>,</span><br><span class="line">      condition: <span class="type">Option</span>[<span class="type">RexNode</span>],</span><br><span class="line">      retainHeader: <span class="type">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">// 添加参数 sideOutputCode</span></span><br><span class="line">      sideOutputCode: <span class="type">String</span> = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      opName: <span class="type">String</span>): <span class="type">CodeGenOperatorFactory</span>[<span class="type">RowData</span>] = &#123;</span><br><span class="line">        ....</span><br><span class="line">    <span class="keyword">val</span> genOperator =</span><br><span class="line">      <span class="type">OperatorCodeGenerator</span>.generateOneInputStreamOperator[<span class="type">RowData</span>, <span class="type">RowData</span>](</span><br><span class="line">        ctx,</span><br><span class="line">        opName,</span><br><span class="line">        processCode,</span><br><span class="line">        inputType,</span><br><span class="line">        inputTerm = inputTerm,</span><br><span class="line">        <span class="comment">// 添加参数 sideOutputCode</span></span><br><span class="line">        sideOutputCode = sideOutputCode,</span><br><span class="line">        lazyInputUnboxingCode = <span class="literal">true</span>)</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OperatorCodeGenerator</code> 添加 <strong>sideOutputCode</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">OperatorCodeGenerator</span> <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generateOneInputStreamOperator</span></span>[<span class="type">IN</span> &lt;: <span class="type">Any</span>, <span class="type">OUT</span> &lt;: <span class="type">Any</span>](</span><br><span class="line">      ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">      name: <span class="type">String</span>,</span><br><span class="line">      processCode: <span class="type">String</span>,</span><br><span class="line">      inputType: <span class="type">LogicalType</span>,</span><br><span class="line">      inputTerm: <span class="type">String</span> = <span class="type">CodeGenUtils</span>.<span class="type">DEFAULT_INPUT1_TERM</span>,</span><br><span class="line">      endInputCode: <span class="type">Option</span>[<span class="type">String</span>] = <span class="type">None</span>,</span><br><span class="line">      lazyInputUnboxingCode: <span class="type">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">// 添加参数 sideOutputCode</span></span><br><span class="line">      sideOutputCode: <span class="type">String</span> = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      converter: <span class="type">String</span> =&gt; <span class="type">String</span> = a =&gt; a): <span class="type">GeneratedOperator</span>[<span class="type">OneInputStreamOperator</span>[<span class="type">IN</span>, <span class="type">OUT</span>]] = &#123;</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      public void processElement($<span class="type">STREAM_RECORD</span> $<span class="type">ELEMENT</span>) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        $inputTypeTerm $inputTerm = ($inputTypeTerm) $&#123;converter(<span class="string">s&quot;<span class="subst">$ELEMENT</span>.getValue()&quot;</span>)&#125;;</span><br><span class="line">        $&#123;ctx.reusePerRecordCode()&#125;</span><br><span class="line">        $&#123;ctx.reuseLocalVariableCode()&#125;</span><br><span class="line">        $&#123;<span class="keyword">if</span> (lazyInputUnboxingCode) <span class="string">&quot;&quot;</span> <span class="keyword">else</span> ctx.reuseInputUnboxingCode()&#125;</span><br><span class="line">        $processCode</span><br><span class="line"></span><br><span class="line">        $sideOutputCode</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 <code>SideOutputCodeUtils</code><br>主要用于添加 测流输出的代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.flink.table.planner.codegen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Collections</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.calcite.rex.&#123;<span class="type">RexCall</span>, <span class="type">RexCallBinding</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.<span class="type">TypeInformation</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.runtime.streamrecord.<span class="type">StreamRecord</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">ValidationException</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">UserDefinedFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.<span class="type">JMap</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.codegen.<span class="type">CodeGenUtils</span>.&#123;<span class="type">BINARY_RAW_VALUE</span>, <span class="type">BINARY_STRING</span>, className, typeTerm&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.functions.bridging.<span class="type">BridgingSqlFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.planner.functions.inference.<span class="type">OperatorBindingCallContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.extraction.<span class="type">ExtractionUtils</span>.primitiveToWrapper</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.inference.<span class="type">TypeInferenceUtil</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.logical.<span class="type">LogicalTypeRoot</span>._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.logical.utils.<span class="type">LogicalTypeChecks</span>.&#123;getFieldCount, getPrecision, getScale&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.types.logical.&#123;<span class="type">DistinctType</span>, <span class="type">LogicalType</span>, <span class="type">RowType</span>, <span class="type">TimestampKind</span>, <span class="type">TimestampType</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.&#123;<span class="type">InstantiationUtil</span>, <span class="type">OutputTag</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConverters</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SideOutputCodeUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addReusable</span></span>(ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">                  tableAndRexCall: <span class="type">Seq</span>[((<span class="type">String</span>, <span class="type">RexCall</span>), <span class="type">Int</span>)],</span><br><span class="line">                  tableAndTagName: <span class="type">JMap</span>[<span class="type">String</span>, <span class="type">String</span>])</span><br><span class="line">      : util.<span class="type">HashMap</span>[<span class="type">String</span>, (<span class="type">String</span>, <span class="type">String</span>)] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableMap = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, (<span class="type">String</span>, <span class="type">String</span>)]()</span><br><span class="line">    tableAndRexCall.foreach &#123;</span><br><span class="line">      t =&gt;</span><br><span class="line">        <span class="keyword">val</span> tableName = t._1._1</span><br><span class="line">        <span class="keyword">val</span> returnClass = getFunctionReturnStr(t._1._2, hasSymbol = <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">val</span> idx = addReferences(ctx, tableName)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> outputTagClass = className[<span class="type">OutputTag</span>[_]]</span><br><span class="line">        <span class="keyword">val</span> typeInformation = className[<span class="type">TypeInformation</span>[_]]</span><br><span class="line">        <span class="keyword">val</span> outputTagFieldTerm = tableAndTagName.get(tableName)</span><br><span class="line">        <span class="keyword">val</span> newOutputTag =</span><br><span class="line">          <span class="string">s&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">             |private $outputTagClass $outputTagFieldTerm = new $outputTagClass(&quot;</span>$outputTagFieldT<span class="string">erm&quot;, <span class="subst">$typeInformation</span>.of(<span class="subst">$returnClass</span>.class))&#123;&#125;;</span></span><br><span class="line"><span class="string">             |&quot;</span><span class="string">&quot;&quot;</span>.stripMargin</span><br><span class="line"></span><br><span class="line">        ctx.addReusableMember(newOutputTag)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> function = t._1._2.getOperator.asInstanceOf[<span class="type">BridgingSqlFunction</span>]</span><br><span class="line">          .getDefinition.asInstanceOf[<span class="type">UserDefinedFunction</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> index = t._2</span><br><span class="line">        <span class="keyword">val</span> functionFieldTerm = <span class="string">s&quot;<span class="subst">$&#123;CodeGenUtils.udfFieldName(function)&#125;</span>_<span class="subst">$index</span>&quot;</span></span><br><span class="line">        <span class="keyword">val</span> fieldTypeTerm = function.getClass.getName</span><br><span class="line">        ctx.addReusableMember(</span><br><span class="line">          <span class="string">s&quot;private transient <span class="subst">$fieldTypeTerm</span> <span class="subst">$functionFieldTerm</span>;&quot;</span>)</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 自定义udf需支持空参构造，并且不支持 open close 方法</span></span><br><span class="line">        ctx.addReusableOpenStatement(<span class="string">s&quot;<span class="subst">$functionFieldTerm</span> = new <span class="subst">$fieldTypeTerm</span>();&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tableMap.put(tableName, (functionFieldTerm, outputTagFieldTerm))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.references.clear()</span><br><span class="line">    tableMap</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">produceProcessCode</span></span>(ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">                         inputType: <span class="type">RowType</span>,</span><br><span class="line">                         collectorTerm: <span class="type">String</span>,</span><br><span class="line">                         inputTerm: <span class="type">String</span>,</span><br><span class="line">                         tableAndRef: util.<span class="type">HashMap</span>[<span class="type">String</span>, (<span class="type">String</span>, <span class="type">String</span>)],</span><br><span class="line">                         tableAndRexCall: <span class="type">Seq</span>[((<span class="type">String</span>, <span class="type">RexCall</span>), <span class="type">Int</span>)]): <span class="type">String</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 table 的入参 [function.eval(?,?,...)]</span></span><br><span class="line">    <span class="keyword">val</span> params = inputType.getFields.asScala.zipWithIndex</span><br><span class="line">      .filter &#123;</span><br><span class="line">        <span class="keyword">case</span> (field, _) =&gt;</span><br><span class="line">          field.getType <span class="keyword">match</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> time:<span class="type">TimestampType</span> =&gt;</span><br><span class="line">              !(time.getKind.ordinal() == <span class="type">TimestampKind</span>.<span class="type">PROCTIME</span>.ordinal())</span><br><span class="line">            <span class="keyword">case</span> _ =&gt; <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;.map &#123;</span><br><span class="line">      <span class="keyword">case</span> (field, index) =&gt;</span><br><span class="line">        <span class="comment">// CodeGenUtils.rowFieldReadAccess(ctx, index, inputTerm, field.getType)</span></span><br><span class="line">        rowFieldReadAccess(ctx, index.toString, inputTerm, field.getType)</span><br><span class="line">    &#125;.mkString(<span class="string">&quot;, &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    val tableToParams = tableAndRexNode.asScala.map &#123; t =&gt;</span></span><br><span class="line">    <span class="comment">//      val fieldList = t._2.getType.getFieldList.asScala</span></span><br><span class="line">    <span class="comment">//      val params = fieldList.zipWithIndex.map &#123;</span></span><br><span class="line">    <span class="comment">//        case (field, index) =&gt;</span></span><br><span class="line">    <span class="comment">//          val logicalType = FlinkTypeFactory.toLogicalType(field.getType)</span></span><br><span class="line">    <span class="comment">//          CodeGenUtils.rowFieldReadAccess(ctx, index, inputTerm, logicalType)</span></span><br><span class="line">    <span class="comment">//      &#125;.mkString(&quot;, &quot;)</span></span><br><span class="line">    <span class="comment">//      (t._1, params)</span></span><br><span class="line">    <span class="comment">//    &#125;.toMap</span></span><br><span class="line"></span><br><span class="line">    tableAndRexCall.map &#123;</span><br><span class="line">      t =&gt;</span><br><span class="line">        <span class="keyword">val</span> index = t._2</span><br><span class="line">        <span class="keyword">val</span> tableName = t._1._1</span><br><span class="line">        <span class="keyword">val</span> returnClass = getFunctionReturnStr(t._1._2, hasSymbol = <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">val</span> (functionFieldTerm, outputTagFieldTerm) = tableAndRef.get(tableName)</span><br><span class="line">        <span class="keyword">val</span> streamRecordClass = className[<span class="type">StreamRecord</span>[_]]</span><br><span class="line">        <span class="keyword">val</span> newStreamRecord = <span class="string">s&quot;new <span class="subst">$streamRecordClass</span>&lt;<span class="subst">$returnClass</span>&gt;(tmp_result<span class="subst">$index</span>)&quot;</span></span><br><span class="line">        <span class="string">s&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">           |$returnClass tmp_result$index = ($returnClass)$functionFieldTerm.eval($params);</span></span><br><span class="line"><span class="string">           |if (java.util.Objects.nonNull(tmp_result$index)) &#123;</span></span><br><span class="line"><span class="string">           |  $collectorTerm.collect($outputTagFieldTerm, $newStreamRecord);</span></span><br><span class="line"><span class="string">           |&#125;</span></span><br><span class="line"><span class="string">           |&quot;</span><span class="string">&quot;&quot;</span>.stripMargin</span><br><span class="line">    &#125;.mkString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addReferences</span></span>(ctx: <span class="type">CodeGeneratorContext</span>, obj: <span class="type">Object</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> idx = ctx.references.length</span><br><span class="line">    <span class="keyword">val</span> byteArray = <span class="type">InstantiationUtil</span>.serializeObject(obj)</span><br><span class="line">    <span class="keyword">val</span> objCopy: <span class="type">AnyRef</span> = <span class="type">InstantiationUtil</span>.deserializeObject(</span><br><span class="line">      byteArray,</span><br><span class="line">      <span class="type">Thread</span>.currentThread().getContextClassLoader)</span><br><span class="line">    ctx.references += objCopy</span><br><span class="line">    idx</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getFunctionReturnStr</span></span>(call: <span class="type">RexCall</span>, hasSymbol: <span class="type">Boolean</span> = <span class="literal">true</span>): <span class="type">String</span> = &#123;</span><br><span class="line">    call.getOperator <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> function: <span class="type">BridgingSqlFunction</span> =&gt;</span><br><span class="line">        <span class="keyword">val</span> udf = function.getDefinition.asInstanceOf[<span class="type">UserDefinedFunction</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> inference = function.getTypeInference</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> callContext = <span class="keyword">new</span> <span class="type">OperatorBindingCallContext</span>(</span><br><span class="line">          function.getDataTypeFactory,</span><br><span class="line">          udf,</span><br><span class="line">          <span class="type">RexCallBinding</span>.create(</span><br><span class="line">            function.getTypeFactory,</span><br><span class="line">            call,</span><br><span class="line">            <span class="type">Collections</span>.emptyList()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> adaptedCallContext = <span class="type">TypeInferenceUtil</span>.adaptArguments(</span><br><span class="line">          inference,</span><br><span class="line">          callContext,</span><br><span class="line">          <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// val enrichedArgumentDataTypes = toScala(adaptedCallContext.getArgumentDataTypes)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> enrichedOutputDataType = <span class="type">TypeInferenceUtil</span>.inferOutputType(</span><br><span class="line">          adaptedCallContext,</span><br><span class="line">          inference.getOutputTypeStrategy)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> externalResultClass = enrichedOutputDataType.getConversionClass</span><br><span class="line">        <span class="keyword">val</span> externalResultTypeTerm = typeTerm(externalResultClass)</span><br><span class="line">        <span class="keyword">val</span> externalResultClassBoxed = primitiveToWrapper(externalResultClass)</span><br><span class="line">        <span class="keyword">val</span> externalResultCasting = <span class="keyword">if</span> (externalResultClass == externalResultClassBoxed) &#123;</span><br><span class="line">          <span class="keyword">if</span> (hasSymbol) <span class="string">s&quot;(<span class="subst">$externalResultTypeTerm</span>)&quot;</span> <span class="keyword">else</span> externalResultTypeTerm</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> has problem ()</span></span><br><span class="line">          <span class="string">s&quot;(<span class="subst">$externalResultTypeTerm</span>) (<span class="subst">$&#123;typeTerm(externalResultClassBoxed)&#125;</span>)&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        externalResultCasting</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> _ =&gt;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">s&quot;<span class="subst">$call</span> is not BridgingSqlFunction&#x27;s instance&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">rowFieldReadAccess</span></span>(</span><br><span class="line">        ctx: <span class="type">CodeGeneratorContext</span>,</span><br><span class="line">        indexTerm: <span class="type">String</span>,</span><br><span class="line">        rowTerm: <span class="type">String</span>,</span><br><span class="line">        t: <span class="type">LogicalType</span>)</span><br><span class="line">  : <span class="type">String</span> = t.getTypeRoot <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="comment">// ordered by type root definition</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">CHAR</span> | <span class="type">VARCHAR</span> =&gt;</span><br><span class="line">      <span class="comment">// 源码中也有该实现, 但对于 String 参数并没有调用 toString() 方法</span></span><br><span class="line">      <span class="string">s&quot;((<span class="subst">$BINARY_STRING</span>) <span class="subst">$rowTerm</span>.getString(<span class="subst">$indexTerm</span>)).toString()&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">BOOLEAN</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getBoolean(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">BINARY</span> | <span class="type">VARBINARY</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getBinary(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">DECIMAL</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getDecimal(<span class="subst">$indexTerm</span>, <span class="subst">$&#123;getPrecision(t)&#125;</span>, <span class="subst">$&#123;getScale(t)&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">TINYINT</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getByte(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">SMALLINT</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getShort(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">INTEGER</span> | <span class="type">DATE</span> | <span class="type">TIME_WITHOUT_TIME_ZONE</span> | <span class="type">INTERVAL_YEAR_MONTH</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getInt(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">BIGINT</span> | <span class="type">INTERVAL_DAY_TIME</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getLong(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">FLOAT</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getFloat(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">DOUBLE</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getDouble(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">TIMESTAMP_WITHOUT_TIME_ZONE</span> | <span class="type">TIMESTAMP_WITH_LOCAL_TIME_ZONE</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getTimestamp(<span class="subst">$indexTerm</span>, <span class="subst">$&#123;getPrecision(t)&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">TIMESTAMP_WITH_TIME_ZONE</span> =&gt;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">UnsupportedOperationException</span>(<span class="string">&quot;Unsupported type: &quot;</span> + t)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">ARRAY</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getArray(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">MULTISET</span> | <span class="type">MAP</span>  =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getMap(<span class="subst">$indexTerm</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">ROW</span> | <span class="type">STRUCTURED_TYPE</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;<span class="subst">$rowTerm</span>.getRow(<span class="subst">$indexTerm</span>, <span class="subst">$&#123;getFieldCount(t)&#125;</span>)&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">DISTINCT_TYPE</span> =&gt;</span><br><span class="line">      rowFieldReadAccess(ctx, indexTerm, rowTerm, t.asInstanceOf[<span class="type">DistinctType</span>].getSourceType)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">RAW</span> =&gt;</span><br><span class="line">      <span class="string">s&quot;((<span class="subst">$BINARY_RAW_VALUE</span>) <span class="subst">$rowTerm</span>.getRawValue(<span class="subst">$indexTerm</span>))&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">NULL</span> | <span class="type">SYMBOL</span> | <span class="type">UNRESOLVED</span> =&gt;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">&quot;Illegal type: &quot;</span> + t)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意事项: codegen, 避免使用泛型类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行时会提取不到 OutputTag 的具体类型</span></span><br><span class="line">OutputTag&lt;Integer&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;Integer&gt;(<span class="string">&quot;a&quot;</span>)&#123;&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> org.apache.flink.api.common.functions.InvalidTypesException: Could not determine TypeInformation <span class="keyword">for</span> the OutputTag type. The most common reason is forgetting to make the OutputTag an anonymous inner class. It is also not possible to use generic type variables with OutputTags, such as <span class="string">&#x27;Tuple2&lt;A, B&gt;&#x27;</span>.</span><br><span class="line">	at org.apache.flink.util.OutputTag.&lt;init&gt;(OutputTag.java:<span class="number">69</span>)</span><br><span class="line">	at com.asuraflink.sideoutput.SideOutPutCase$<span class="number">3</span>$<span class="number">1.</span>&lt;init&gt;(SideOutPutCase.java:<span class="number">21</span>)</span><br><span class="line">	at com.asuraflink.sideoutput.SideOutPutCase$<span class="number">3.</span>&lt;init&gt;(SideOutPutCase.java:<span class="number">21</span>)</span><br><span class="line">	at com.asuraflink.sideoutput.SideOutPutCase.main(SideOutPutCase.java:<span class="number">19</span>)</span><br><span class="line">Caused by: org.apache.flink.api.common.functions.InvalidTypesException: The types of the <span class="class"><span class="keyword">interface</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">util</span>.<span class="title">OutputTag</span> <span class="title">could</span> <span class="title">not</span> <span class="title">be</span> <span class="title">inferred</span>. <span class="title">Support</span> <span class="title">for</span> <span class="title">synthetic</span> <span class="title">interfaces</span>, <span class="title">lambdas</span>, <span class="title">and</span> <span class="title">generic</span> <span class="title">or</span> <span class="title">raw</span> <span class="title">types</span> <span class="title">is</span> <span class="title">limited</span> <span class="title">at</span> <span class="title">this</span> <span class="title">point</span></span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">getParameterType</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:1185)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">getParameterTypeFromGenericType</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:1209)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">getParameterType</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:1180)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">privateCreateTypeInfo</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:733)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">createTypeInfo</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:713)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">api</span>.<span class="title">java</span>.<span class="title">typeutils</span>.<span class="title">TypeExtractor</span>.<span class="title">createTypeInfo</span>(<span class="title">TypeExtractor</span>.<span class="title">java</span>:706)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">flink</span>.<span class="title">util</span>.<span class="title">OutputTag</span>.&lt;<span class="title">init</span>&gt;(<span class="title">OutputTag</span>.<span class="title">java</span>:66)</span></span><br><span class="line"><span class="class">	... 3 <span class="title">more</span></span></span><br></pre></td></tr></table></figure>


<p>应该指定 <code>OutputTag</code> 的 <code>TypeInformation</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputTag outputTag = <span class="keyword">new</span> OutputTag(<span class="string">&quot;a&quot;</span>, TypeInformation.of(Integer.class))&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="六、添加-Sink-输出"><a href="#六、添加-Sink-输出" class="headerlink" title="六、添加 Sink 输出"></a>六、添加 Sink 输出</h2><h3 id="未完待续-…"><a href="#未完待续-…" class="headerlink" title="未完待续 …"></a>未完待续 …</h3><h1 id="2000-YEARS-LATER-…"><a href="#2000-YEARS-LATER-…" class="headerlink" title="2000 YEARS LATER …"></a>2000 YEARS LATER …</h1><p><img src="/img/blog/wulian.png" alt="捂脸表情包.jpeg"></p>
<h2 id="续不下去，另辟蹊径了，哈哈哈哈哈😃"><a href="#续不下去，另辟蹊径了，哈哈哈哈哈😃" class="headerlink" title="续不下去，另辟蹊径了，哈哈哈哈哈😃"></a>续不下去，另辟蹊径了，哈哈哈哈哈😃</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Asura7969</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://asura7969.github.io/2021/06/05/Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%B8%80/">https://asura7969.github.io/2021/06/05/Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%B8%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://asura7969.github.io" target="_blank">Asura7969 Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/flink/">flink</a></div><div class="post_share"><div class="social-share" data-image="/img/topimg/202106050955.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/05/Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%BA%8C/"><img class="prev-cover" src="/img/topimg/202106050956.png" onerror="onerror=null;src='/img/404-b.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Flink Sql 侧流输出(二)</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/15/Mini-Batch-%E7%BB%B4%E8%A1%A8-Join/"><img class="next-cover" src="/img/topimg/20210515223350.jpg" onerror="onerror=null;src='/img/404-b.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Mini-Batch 维表 Join</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/01/06/Expand Flink Sql/" title="Expand Flink Sql"><img class="cover" src="/img/topimg/202105161045.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-06</div><div class="title">Expand Flink Sql</div></div></a></div><div><a href="/2021/03/07/Flink 1.12.0源码编译/" title="Flink 1.12.0源码编译"><img class="cover" src="/img/topimg/202106050953.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-07</div><div class="title">Flink 1.12.0源码编译</div></div></a></div><div><a href="/2021/02/20/Flink Graph/" title="Flink Graph"><img class="cover" src="/img/topimg/202105161043.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-20</div><div class="title">Flink Graph</div></div></a></div><div><a href="/2021/04/21/Flink Sql LookupJoinWithBykey/" title="Flink SQL LookupJoin With KeyBy"><img class="cover" src="/img/topimg/20210515223410.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-21</div><div class="title">Flink SQL LookupJoin With KeyBy</div></div></a></div><div><a href="/2021/03/04/Flink Checkpoint恢复流程/" title="Flink Checkpoint 恢复流程"><img class="cover" src="/img/topimg/202105161039.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-04</div><div class="title">Flink Checkpoint 恢复流程</div></div></a></div><div><a href="/2021/04/14/Flink DataStream与Transformation/" title="Flink DataStream与Transformation"><img class="cover" src="/img/topimg/202106050950.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-14</div><div class="title">Flink DataStream与Transformation</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/shanyi.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Asura7969</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">37</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Asura7969"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Asura7969" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1402357969@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flink-Sql-%E4%BE%A7%E6%B5%81%E8%BE%93%E5%87%BA-%E4%B8%80"><span class="toc-number">1.</span> <span class="toc-text">Flink Sql 侧流输出(一)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%B7%BB%E5%8A%A0%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.</span> <span class="toc-text">一、添加提示信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81SqlToOperationConverter-%E6%B7%BB%E5%8A%A0%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.3.</span> <span class="toc-text">二、SqlToOperationConverter 添加校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BF%AE%E6%94%B9-PROJECT-TO-CALC"><span class="toc-number">1.4.</span> <span class="toc-text">三、修改 PROJECT_TO_CALC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%87%8D%E5%86%99-FlinkLogicalCalc-%E8%8A%82%E7%82%B9"><span class="toc-number">1.5.</span> <span class="toc-text">四、重写 FlinkLogicalCalc 节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%B7%BB%E5%8A%A0-StreamExecSideOutputCalc"><span class="toc-number">1.6.</span> <span class="toc-text">五、添加 StreamExecSideOutputCalc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%B7%BB%E5%8A%A0-Sink-%E8%BE%93%E5%87%BA"><span class="toc-number">1.7.</span> <span class="toc-text">六、添加 Sink 输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD-%E2%80%A6"><span class="toc-number">1.7.1.</span> <span class="toc-text">未完待续 …</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2000-YEARS-LATER-%E2%80%A6"><span class="toc-number">2.</span> <span class="toc-text">2000 YEARS LATER …</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%AD%E4%B8%8D%E4%B8%8B%E5%8E%BB%EF%BC%8C%E5%8F%A6%E8%BE%9F%E8%B9%8A%E5%BE%84%E4%BA%86%EF%BC%8C%E5%93%88%E5%93%88%E5%93%88%E5%93%88%E5%93%88%F0%9F%98%83"><span class="toc-number">2.1.</span> <span class="toc-text">续不下去，另辟蹊径了，哈哈哈哈哈😃</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/13/Deltalake-CDF-CDC/" title="Deltalake CDF &amp; CDC"><img src="/img/topimg/16.png" onerror="this.onerror=null;this.src='/img/404-b.jpg'" alt="Deltalake CDF &amp; CDC"/></a><div class="content"><a class="title" href="/2022/10/13/Deltalake-CDF-CDC/" title="Deltalake CDF &amp; CDC">Deltalake CDF &amp; CDC</a><time datetime="2022-10-13T12:54:35.000Z" title="发表于 2022-10-13 20:54:35">2022-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/17/kafka%E5%8D%87%E7%BA%A7-Security/" title="kafka升级-Security"><img src="/img/topimg/202202172112.png" onerror="this.onerror=null;this.src='/img/404-b.jpg'" alt="kafka升级-Security"/></a><div class="content"><a class="title" href="/2022/02/17/kafka%E5%8D%87%E7%BA%A7-Security/" title="kafka升级-Security">kafka升级-Security</a><time datetime="2022-02-17T13:11:12.000Z" title="发表于 2022-02-17 21:11:12">2022-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/17/kafka-SCRAM-ACL%E9%85%8D%E7%BD%AE/" title="kafka &amp;&amp; SCRAM + ACL配置"><img src="/img/topimg/202111111633.png" onerror="this.onerror=null;this.src='/img/404-b.jpg'" alt="kafka &amp;&amp; SCRAM + ACL配置"/></a><div class="content"><a class="title" href="/2022/02/17/kafka-SCRAM-ACL%E9%85%8D%E7%BD%AE/" title="kafka &amp;&amp; SCRAM + ACL配置">kafka &amp;&amp; SCRAM + ACL配置</a><time datetime="2022-02-17T13:04:36.000Z" title="发表于 2022-02-17 21:04:36">2022-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/23/kafka%E7%AD%94%E7%96%91/" title="kafka答疑"><img src="/img/topimg/202109231909.png" onerror="this.onerror=null;this.src='/img/404-b.jpg'" alt="kafka答疑"/></a><div class="content"><a class="title" href="/2021/09/23/kafka%E7%AD%94%E7%96%91/" title="kafka答疑">kafka答疑</a><time datetime="2021-09-23T11:08:11.000Z" title="发表于 2021-09-23 19:08:11">2021-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/23/kafka%E8%87%AA%E5%AE%9A%E4%B9%89quota%E8%A7%84%E5%88%99/" title="kafka自定义quota规则"><img src="/img/topimg/202109231535.png" onerror="this.onerror=null;this.src='/img/404-b.jpg'" alt="kafka自定义quota规则"/></a><div class="content"><a class="title" href="/2021/09/23/kafka%E8%87%AA%E5%AE%9A%E4%B9%89quota%E8%A7%84%E5%88%99/" title="kafka自定义quota规则">kafka自定义quota规则</a><time datetime="2021-09-23T07:33:30.000Z" title="发表于 2021-09-23 15:33:30">2021-09-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Asura7969</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>